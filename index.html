<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <title>Scythe charts</title>
  <meta name="description" content="Scythe charts">
  <meta name="author" content="Dimitris Raviolos">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Sail" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.css">
  <link rel="stylesheet" type="text/css" href="scythe.css">
</head>
<body>
  <div class="grid"></div>
  <script id="template" type="x-tmpl-mustache">
    <div class="row {{col}}">
      <div id="chart{{id}}">
        <h3>{{desc}}</h3>
        <div class="ct-chart ct-octave"></div>
      </div>
    </div>
  </script>
  <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/chartist.js/latest/chartist.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>
  <script>
    const plays = [{
      country: 'Crimea', board: 'Industrial', winner: 'Dimitris'
    }, {
      country: 'Saxony', board: 'Patriotic', winner: 'Panagiotis', points: 99
    }, {
      country: 'Nordic', board: 'Industrial', winner: 'Dimitris'
    }, {
      country: 'Saxony', board: 'Industrial', winner: 'Elena'
    }, {
      country: 'Crimea', board: 'Engineering', winner: 'Kostas'
    }, {
      country: 'Nordic', board: 'Mechanical', winner: 'Dimitris', points: 64
    }, {
      country: 'Polania', board: 'Agricultural', winner: 'Panagiotis', points: 78
    }, {
      country: 'Rusviet', board: 'Industrial', winner: 'Kostas', points: 57
    }, {
      country: 'Nordic', board: 'Patriotic', winner: 'Panagiotis', points: 68
    }, {
      country: 'Saxony', board: 'Mechanical', winner: 'Kostas', points: 75
    }, {
      country: 'Saxony', board: 'Industrial', winner: 'Dimitris', points: 66
    }, {
      country: 'Rusviet', board: 'Industrial', winner: 'Kalliopi', points: 54
    }, {
      country: 'Crimea', board: 'Mechanical', winner: 'Kostas', points: 80
    }, {
      country: 'Rusviet', board: 'Industrial', winner: 'Dimitris', points: 60
    }, {
      country: 'Polania', board: 'Patriotic', winner: 'Dimitris', points: 76
    }, {
      country: 'Saxony', board: 'Engineering', winner: 'Dimitris', points: 77
    }, {
      country: 'Crimea', board: 'Engineering', winner: 'Dimitris', points: 53, rounds: 18
    }, {
      country: 'Nordic', board: 'Mechanical', winner: 'Dimitris', points: 56, rounds: 18
    }, {
      country: 'Polania', board: 'Patriotic', winner: 'Elena', points: 47, rounds: 16
    }, {
      country: 'Polania', board: 'Agricultural', winner: 'Elena', points: 58, rounds: 19
    }];
    const template = $('#template').html();
    const countries = ['Saxony', 'Rusviet', 'Nordic', 'Polania', 'Crimea'];
    const players = ['Dimitris', 'Panagiotis', 'Elena', 'Kostas', 'Kalliopi'];
    const boards = ['Industrial', 'Engineering', 'Patriotic', 'Mechanical', 'Agricultural'];

    function stackedBar(series, labels, data) {
      data.col = data.col || 'col2';
      $('.grid').append(Mustache.render(template, data))

      new Chartist.Bar('#chart' + data.id + ' > div', {
        labels: labels,
        series: series
      }, {
        stackBars: true,

        axisY: {
          labelInterpolationFnc: function(value) {
            return Number.isInteger(value) ? value : null;
          }
        }
      }).on('draw', function (data) {
        if (data.type === 'bar') {
          data.element.attr({
            style: 'stroke-width: 0px'
          });

          for (var s = 0; s < data.series.length; ++s) {
            if (data.seriesIndex === s) {
              data.element.animate({
                y2: {
                  begin:  s * 500,
                  dur:    500,
                  from:   data.y1,
                  to:     data.y2,
                  easing: Chartist.Svg.Easing.easeOutSine
                },
                'stroke-width': {
                  begin: s * 500,
                  dur:   1,
                  from:  0,
                  to:    30,
                  fill:  'freeze'
                }
              }, false);
            }
          }
        }
      });
    }

    function winsByCountry(acc, cur) {
      var c = countries.indexOf(cur.country);
      var p = players.indexOf(cur.winner);
      acc[p][c]++;
      return acc;
    }

    function winsByBoard(acc, cur) {
      var b = boards.indexOf(cur.board);
      var p = players.indexOf(cur.winner);
      acc[p][b]++;
      return acc;
    }

    function winsByPlayer(acc, cur) {
      var p = players.indexOf(cur.winner);
      acc[p][p]++;
      return acc;
    }

    function winStatistics(acc, cur) {
      var p = players.indexOf(cur.winner);
      acc[p][0] += cur.points;
      acc[p][1]++;
      return acc;
    }

    function averageWinPoints(acc, cur, p) {
      if (cur[1] > 0) {
        acc[p][p] = cur[0] / cur[1];
      }
      return acc;
    }

    function combinationOnCountry(id, country) {
      const combinations = countries.filter(d => d === country).map(
        (c) => boards.map((b) => c + ' ' + b)
      ).reduce(
        (acc, cur) => { cur.forEach((a) => acc.push(a)); return acc; }
      )

      function winsByCombinations(acc, cur) {
        var p = players.indexOf(cur.winner);
        var c = combinations.indexOf(cur.country + ' ' + cur.board);
        acc[p][c]++;
        return acc;
      }

      stackedBar(
        plays.reduce(winsByCombinations, players.map(() => combinations.map(() => 0))),
        combinations,
        { id: id, desc: 'Wins by ' +  country + ' combination' }
      )
    }

    stackedBar(
      plays.reduce(winsByPlayer, players.map(() => players.map(() => 0))),
      players, { id: 1, desc: 'Wins' }
    )

    stackedBar(
      plays.filter(d => d.points !== undefined)
      .reduce(winStatistics, players.map(() => [0, 0]))
      .reduce(averageWinPoints, players.map(() => players.map(() => 0))),
      players, { id: 2, desc: 'Average winning points' }
    )

    stackedBar(
      plays.reduce(winsByCountry, players.map(() => countries.map(() => 0))),
      countries, { id: 3, desc: 'Wins by country' }
    )

    stackedBar(
      plays.reduce(winsByBoard, players.map(() => boards.map(() => 0))),
      boards, { id: 4, desc: 'Wins by board' }
    )

    countries.forEach(
      (country, index) => combinationOnCountry(5 + index, country)
    )
  </script>
</body>
</html>
